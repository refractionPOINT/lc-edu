<htmL>
    <head>
        <link rel="stylesheet" href="style.css">
    </head>
    <body>
        <div class="container">

            <h2>Introduction</h2>

            <p>The goal of this portion of the course is to create a DR rule to detect the MITRE ATT&CK framework for <a href="https://attack.mitre.org/techniques/T1196/" target="_blank">Control Panel Items</a> execution, as well as validate, test and publish the rule.</p> 

            <h3>Setup and Requirements</h3>

            <p>To complete this section of the course you will need access to a Linux host (or MacOS terminal with <a href="https://brew.sh/" target="_blank">brew</a> installed). Along with this you will also need owner access to an organization on LimaCharlie. If you do not have an organization already you can create one - this code lab is completely compatiable with the free teir provided to all LimaCharlie users.</p>

            <h3>Services Used</h3>

            <p>This code lab will use the Detection & Response service as well as the Replay service to validate and the rule prior to pushing it to production</p>

            <h2>Getting Started</h2>

            <p>Interacting with LC can always be done via the web app but day-to-day operations and automation can be done via the Command Line Interface (CLI). This will make following this code lab easier.</p>

            <p>Install the CLI: <code>pip install limacharlie --user</code></p>
                
            <p>If you don't have <code>pip</code> installed, install it, the exact instructions will depend on your Linux distribution.</p>

            <h3>Create REST API Key</h3>

            <p>We need to create an API key we can use in the CLI to authenticate with LC. To do so, go to the REST API section of the web app.</p>

            <ol>
                <li>In the REST API section, click the "+" button in the top right of the page.</li>
                
                <li>Give your key a name.</li>
                
                <li>For simplicity, click the "Select All" button to enable all permissions. Obviously this would not be a recomended in a production environment. Details on the LimaCharlie's access scheme can be found here: <a href="https://doc.limacharlie.io/docs/documentation/docs/lc-access.md" target="_blank">lc-access</a></li>
                
                <li>Click the copy-to-clipboard button for the new key and take note of it (pasting it in a temporary text note for example).</li>
                
                <li>Back on the REST API page, copy the "Organization ID" at the top of the page and keep note of it like the API key in the previous step.</li>
            
            </ol>
           <p>The Organization ID (OID) identifies uniquely your organization while the API key grants specific perissions to this organization.</p>

            <h3>Login to the CLI</h3>

            <p>Back in your terminal, log in with your credentials: <code>limacharlie login</code></p>

            <ol>
                <li>When asked for the Organization ID, paste your OID from the previous step.</li>
                
                <li>  When asked for a name for this access, you can leave it blank to set the default credentials.</li>
                
                <li>When asked for the secret API key, enter the key you got from the previous step.</li>
                
                <li>You're done! If you issue a <code>limacharlie-dr list</code> you should not get any errors.</li>
            </ol>

            <h2>Draft Rule</h2>

            <p>To draft our rule, open your prefered text editor and save the rule to a file, we'll call it <code>T1196.rule</code>. The format of a rule is <a href="https://en.wikipedia.org/wiki/YAML" target="_blank">YAML</a>, if you are not familiar with it you're best spending a few minutes getting familiar. It is not too complex.</p>

            <ul>
                <li>For our rules based on the <a href="https://attack.mitre.org/techniques/T1196/" target="_blank">T1196</a> technique, we need to apply the following constraints:</li>
                <li>It only applies to Windows.</li>
                <li>The event is a module (DLL for example on Windows) loading.</li>
                <li>The module loading ends with <code>.cpl</code> (control panel extension).</li>
                <li>The module is loading from outside of the <code>C:\windows\</code> directory.</li>
            </ul>

            <p>LC supports a lot of different event types, this means that the first thing we should strive to do to try to make the rule fail as quickly as possible is to filter all events we don't care about.</p>

            <p>In this case, we only care about <a href="https://doc.limacharlie.io/docs/documentation/docs/events.md#code_identity" target="_blank">CODE_IDENTITY</a> events. We also know that our rule will use more than one criteria, and those criteria will be AND-ed together because we only want to match when they all match.</p>

            <script src="https://gist.github.com/tekgrunt/d54c2076e899d36d74bff57e2874360a.js"></script>

            <p>The above sets up the criteria #2 from above and the AND-ing that will follow. Since the AND is at the top of our rule, and it has an <code>event:</code> clause, it will ensure that any event processed by this rule but is NOT a <code>CODE_IDENTITY</code> event will be skipped over right away.</p>

            <p>Next, we should look at the other criteria, and add them to the rules: list, which are all the sub-nodes that will be AND-ed together.</p>

            <p>Criteria #1 was to limit to Windows, that's easy:</p>

            <script src="https://gist.github.com/tekgrunt/ba9e76b1b07b6ca33bb6647838ec781e.js"></script>

            <p>Next up is criteria #3 and #4. Both of those can be determined using the <code>FILE_PATH</code> component of the <code>CODE_IDENTITY</code> event. If you are unure what those events look like, the best way to get a positive confirmation of the structure is simply to open the Historic View, start a new process on that specific host and look for the relevant event. If we were to do this on a Windows host, we'd get an example like this one:</p>

            <script src="https://gist.github.com/tekgrunt/fc2a10298789db261a809ac91417a92a.js"></script>

            <p>This means what we want is to apply rules to the event/FILE_PATH. First part, #3 is easy, we just want to test for the <code>event/FILE_PATH</code> ends in <code>.cpl</code>, we can do this using the <code>ends with</code> operator.</p>

            <p>Most operators will use a <code>path</code> and a <code>value</code>. The general convention is that the path describes how to get to a value we want to compare within the event. So <code>event/FILE_PATH</code> says "starting in the event then get the <code>FILE_PATH</code>. The value generally represents a value we want to compare to the element found in the path, how we compare depends on the operator.</p>

            <script src="https://gist.github.com/tekgrunt/b044bc6ee8a778b4524c35c8c88b9eb7.js"></script>

            <p>That was easy, but we're missing a critical componet! By default, D&R rules operate in a case sensitive mode. This means that the above node we added will match <code>.cpl</code> but will NOT match <code>.cPl</code>. To fix this, we just add the <code>case sensitive: false</code> statement.</p>

            <script src="https://gist.github.com/tekgrunt/e8e81b6026d3870d82748f762f0224d4.js"></script>

            <p>Finally, we want to make sure the <code>event/FILE_PATH</code> is NOT in the <code>windows</code> directory. To do this, we will use a regular expression with a <code>matches</code> operator. But in this case, we want to EXCLUDE the paths that include the <code>windows</code> directory, so we want to "invert" the match. We can do this with the <code>not: true</code> statement.</p>

            <script src="https://gist.github.com/tekgrunt/36d24fcef7cbeac37f57a6b7e07dff33.js"></script>

            Here we go, we're done drafting our first rule.

            <h2>Validating Your Rule</h2>

           <p>What we want to do now is validate the rule. If the rule validates, it doesn't mean it's correct, it just means that the structure is correct, the operators we use are known etc. It's the first pass at detecting possible formatting issues or typos.</p>

            <p>Do validate, we will simply leverage the Replay service. This service can be used to test rules or replay historical events against a rule. In this case however, we just want to start by validating.</p>

            <p>Up until now we focused on the "detection" part of the rule. But a full rule also contains a "response" component. So before we proceed, we'll just add this structure. For a response, we will just use a simple <code>action: report</code>. The <code>report</code> simply creates a "detection" (alert).</p>

            <script src="https://gist.github.com/tekgrunt/d92d9d462c84695800156cdca4489e9e.js"></script>

            <p>Now validate: <code>limacharlie-replay --validate --rule-content T1196.rule</code></p>

            <p>After a few seconds, you should see a response with <code>success: true</code> if the rule validates properly.</p>

            <h2>Testing Your Rule</h2>

            <p>Now that we know our rule is generally sound, we need to test it against some events.</p>

            <p>Our test plan will take the following approach:</p>

            <ol>
                <li>Test a positive (a <code>.cpl</code> loading outside of <code>windows</code>).</li>

                <li>Test a negative for the major criteria: 
                    <ol>
                        <li>Test a non-<code>.cpl</code> loading outside of windows does not match.</li>
                        <li>Test a <code>.cpl</code> loading within <code>windows</code> does not match.</li>
                    </ol>
                </li>

                <li>Test on historical data.</li>
            </ol>

            <p>With this plan, #1 and #2 lend themselves well to <a href="http://softwaretestingfundamentals.com/unit-testing/" target="_blank">unit tests</a> while the #3 can be done more holistically by just using Replay to run historical events through the rule and evaluate if there are any <a href="https://en.wikipedia.org/wiki/False_positives_and_false_negatives" target="_blank">false positives</a>.</p>

            <p>This may be over-kill for you, or for certain rules which are very simple, we leave that evaluation to you. For the sake of this code lab, we will do a light version to demonstrate how to do tests.</p>

            <h3>Testing a Single Event</h3>

            <p>To tests #1 and #2, let's just create some synthetic events. It's always better to use real-world samples, but we'll leave that up to you.</p>

            <p>Take the event sample we had in the "Draft Rule" section and copy it to two new files we will name <code>positive.json</code>, <code>negative-1.json</code> and <code>negative-2.json</code>.
            
            <p>Modify the <code>positive.json</code> file by renaming the <code>FILE_PATH</code> at the bottom from <code>"C:\\Windows\\System32\\setupcln.dll"</code> to <code>"C:\\temp\\System32\\setupcln.cpl"</code> so that the event now describes a <code>.cpl</code> loading in the <code>temp</code> directory, which we should detect.</p>
            
            <p>Then modify the <code>negative-1.json</code> file by changing the same <code>.dll</code> to <code>.cpl</code>. This should NOT match because the path is still in the <code>windows</code> directory.
            
            <p>Then modify the <code>negative-2.json</code> file by changing the <code>windows</code> directory to <code>temp</code>. This should still NOT match because it's not a <code>.cpl</code>.</p>
            
            <p>Now we can run our 3 samples against the rule using Replay,</p>
            
            <p><code>limacharlie-replay --rule-content T1196.rule --events positive.json</code> should output a result indicating the event matched (by actioning the <code>report</code>) like:</p>

            <script src="https://gist.github.com/tekgrunt/96d9d41ca507829ab0f6363734ea6193.js"></script>

            <p><code>limacharlie-replay --rule-content T1196.rule --events negative-1.json</code> should output a result indicating the event did NOT match like:</p>

            <script src="https://gist.github.com/tekgrunt/a2559c26af1fcca9604ed2b854d89025.js"></script>

            <p><code>limacharlie-replay --rule-content T1196.rule --events negative-2.json</code> be the same as <code>negative-1.json</code>.</p>

            <h3>Testing Historical Data</h3>

            <p>The final test is to run the rule against historical data. If you are not using an organization on the free tier, note that the Replay API is billed on usage, in the following step we will run against all historical data from the organization, so if your organization is not on the free tier and it is large, there may be non-trivial costs associated.</p>
            
            <p>Running our rule against the last week of data is simple:</p>
            
            <p><code>limacharlie-replay --rule-content T1196.rule --entire-org --last-seconds 604800</code></p>
            
            <p>No matches should look like that:</p>

            <script src="https://gist.github.com/tekgrunt/a164013451f8ae18aaf6ccaf781ec5ef.js"></script>

            <h3>Publish Your Rule</h3>

            <p>Now is the time to push the new rule to production, the easy part.</p>

            <p>Simply run <code>limacharlie-dr add --rule-name T1196 --rule-file T1196.rule</code> and confirm it is operational by running <code>limacharlie-dr list</code>.</p>

    </body>
</htmL>